configs:
  caddyfile:
    file: ./Caddyfile
  authelia:
    file: ./configuration.yml

networks:
  db:
  ldap:
  authelia:
  silicon:
  nextcloud:
  yarr:

volumes:
  db16:
  db17:
  lldap_data:
  authelia_config:
  silicon_instance:
  caddy_data:
  caddy_config:
  nextcloud:
  yarr:

services:
  db:
    image: docker.io/postgres:16
    env_file:
      - db.env
    networks:
      - db
    volumes:
      - "db16:/var/lib/postgresql/data"
    restart: unless-stopped

  dbtemp:
    image: docker.io/postgres:17
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - db
    volumes:
      - "db17:/var/lib/postgresql/data"
    restart: unless-stopped

  lldap:
    image: docker.io/lldap/lldap:v0.5.0
    env_file:
      - tz.env
      - lldap.env
    ports:
      - "127.0.0.1:17170:17170"
    networks:
      - ldap
    volumes:
      - "lldap_data:/data"
    restart: unless-stopped

  authelia:
    image: docker.io/authelia/authelia:4.38.9
    env_file:
      - authelia.env
    configs:
      - source: authelia
        target: /config/configuration.yml
    depends_on:
      - lldap
    networks:
      - ldap
      - authelia
    volumes:
      - "authelia_config:/config"
    restart: unless-stopped

  silicon:
    image: docker.io/bityard/silicon
    networks:
      - silicon
    volumes:
      - silicon_instance:/home/silicon/instance
    restart: unless-stopped

  caddy:
    image: docker.io/caddy:2.8.4
    env_file:
      - caddy.env
    configs:
      - source: caddyfile
        target: /etc/caddy/Caddyfile
    depends_on:
      - authelia
      - silicon
      - nextcloud
      - yarr
    ports:
      - "80:80"
      - "443:443"
    networks:
      - authelia
      - silicon
      - nextcloud
      - yarr
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped

  nextcloud: &nextcloud
    image: docker.io/nextcloud:29.0.3
    env_file:
      - tz.env
      - nextcloud.env
    depends_on:
      - db
    networks:
      - db
      - nextcloud
    volumes:
      - nextcloud:/var/www/html
    restart: unless-stopped

  nextcloud-cron:
    <<: *nextcloud
    entrypoint: /cron.sh

  yarr:
    image: ghcr.io/wakeful-cloud/yarr:sha-d15b43b
    networks:
      - yarr
    volumes:
      - yarr:/data
    restart: unless-stopped
